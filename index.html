<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hidrata√ß√£o</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #03111f;
    --water1: #0ea5e9;
    --water2: #38bdf8;
    --water3: #7dd3fc;
    --foam: #bae6fd;
    --accent: #06b6d4;
    --glow: rgba(14,165,233,0.4);
    --text: #e0f2fe;
    --muted: #7dd3fc88;
  }

  body {
    background: transparent;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
  }

  .widget {
    width: 340px;
    padding: 26px 22px 20px;
    background: linear-gradient(160deg, #0a2035 0%, #061525 100%);
    border: 1px solid rgba(14,165,233,0.2);
    border-radius: 24px;
    box-shadow:
      0 0 60px rgba(14,165,233,0.08),
      0 20px 60px rgba(0,0,0,0.6),
      inset 0 1px 0 rgba(255,255,255,0.05);
    position: relative;
    overflow: hidden;
  }
  .widget::before {
    content: '';
    position: absolute;
    top: 0; left: 10%; right: 10%; height: 1px;
    background: linear-gradient(90deg, transparent, var(--water2), transparent);
    opacity: 0.5;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 18px;
  }
  .title {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 700; font-size: 22px;
    color: var(--water2); letter-spacing: -0.3px;
  }
  .date-badge {
    font-size: 10px; color: var(--muted);
    text-align: right; line-height: 1.6; letter-spacing: 0.5px;
  }

  /* ‚îÄ‚îÄ VESSEL ‚îÄ‚îÄ */
  .vessel-wrap {
    display: flex; align-items: flex-end; gap: 22px; margin-bottom: 20px;
  }
  .vessel-svg-wrap {
    width: 72px; flex-shrink: 0;
    display: flex; flex-direction: column; align-items: center; gap: 10px;
  }
  .vessel-svg {
    cursor: pointer; display: block; overflow: visible;
    filter: drop-shadow(0 0 8px rgba(14,165,233,0.2));
    transition: filter 0.3s;
  }
  .vessel-svg:hover { filter: drop-shadow(0 0 16px rgba(14,165,233,0.44)); }

  /* Waves are static ‚Äî no scroll animation */
  .wave-inner-1, .wave-inner-2 { /* no animation */ }

  /* Type toggle */
  .type-toggle { display: flex; gap: 6px; }
  .type-btn {
    width: 32px; height: 24px;
    border: 1px solid rgba(125,211,252,0.2);
    border-radius: 6px;
    background: rgba(14,165,233,0.06);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; padding: 0;
  }
  .type-btn.active {
    background: rgba(14,165,233,0.2);
    border-color: rgba(125,211,252,0.5);
    box-shadow: 0 0 8px rgba(14,165,233,0.3);
  }
  .type-btn:hover:not(.active) { background: rgba(14,165,233,0.12); }

  /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
  .vessel-stats { flex: 1; }
  .big-count {
    font-family: 'DM Mono', monospace;
    font-size: 48px; line-height: 1; color: var(--foam);
    letter-spacing: -2px; text-shadow: 0 0 28px var(--glow);
  }
  .big-count .unit {
    font-size: 14px; font-weight: 300; color: var(--muted);
    letter-spacing: 1px; vertical-align: middle; margin-left: 2px;
  }
  .goal-line {
    font-size: 11px; color: var(--muted);
    margin: 4px 0 12px; letter-spacing: 0.3px;
    display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
  }
  .goal-line b { color: var(--water3); font-weight: 400; }
  .vol-btn {
    background: none;
    border: 1px solid rgba(125,211,252,0.2);
    border-radius: 6px; padding: 2px 7px;
    font-family: 'DM Mono', monospace; font-size: 10px;
    color: var(--muted); cursor: pointer; transition: all 0.2s;
  }
  .vol-btn:hover { border-color: var(--water2); color: var(--water3); background: rgba(14,165,233,0.08); }
  .btns { display: flex; gap: 8px; }
  .btn {
    flex: 1; padding: 9px 0; border: none; border-radius: 10px;
    font-family: 'DM Mono', monospace; font-size: 18px;
    cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
  }
  .btn-add {
    background: linear-gradient(135deg, var(--water1), var(--accent));
    color: #fff; box-shadow: 0 4px 20px rgba(14,165,233,0.35);
  }
  .btn-add:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(14,165,233,0.5); }
  .btn-add:active { transform: scale(0.95); }
  .btn-remove {
    background: rgba(14,165,233,0.08); color: var(--muted);
    border: 1px solid rgba(14,165,233,0.15);
  }
  .btn-remove:hover { background: rgba(14,165,233,0.15); color: var(--water3); }

  /* ‚îÄ‚îÄ VOL PANEL ‚îÄ‚îÄ */
  .vol-panel {
    display: none; flex-direction: column; gap: 8px;
    margin-bottom: 14px;
    background: rgba(14,165,233,0.06);
    border: 1px solid rgba(14,165,233,0.15);
    border-radius: 12px; padding: 12px 14px;
  }
  .vol-panel.open { display: flex; animation: slide-down 0.22s ease; }
  @keyframes slide-down {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .vol-row {
    display: flex; align-items: center; gap: 10px;
    font-size: 11px; color: var(--muted);
  }
  .vol-row label { flex: 1; }

  /* Custom number input: hide native spinner, use ‚Üë‚Üì buttons */
  .num-wrap {
    display: flex; align-items: center; gap: 0;
    border: 1px solid rgba(14,165,233,0.25);
    border-radius: 7px; overflow: hidden;
  }
  .vol-input {
    width: 58px;
    background: rgba(14,165,233,0.1);
    border: none; border-right: 1px solid rgba(14,165,233,0.15);
    padding: 4px 6px;
    font-family: 'DM Mono', monospace; font-size: 12px;
    color: var(--foam); text-align: right;
    outline: none;
    -moz-appearance: textfield;
  }
  .vol-input::-webkit-inner-spin-button,
  .vol-input::-webkit-outer-spin-button { -webkit-appearance: none; }
  .vol-input:focus { background: rgba(14,165,233,0.16); }

  .spin-btns {
    display: flex; flex-direction: column;
    background: rgba(14,165,233,0.08);
  }
  .spin-btn {
    background: none; border: none;
    padding: 0 6px;
    font-size: 10px; line-height: 1;
    color: var(--muted); cursor: pointer;
    transition: color 0.15s, background 0.15s;
    height: 14px; display: flex; align-items: center;
  }
  .spin-btn:hover { color: var(--foam); background: rgba(14,165,233,0.18); }
  .spin-btn:active { color: var(--water2); }

  .vol-hint {
    font-size: 10px; color: var(--water3);
    background: rgba(14,165,233,0.08);
    border-radius: 6px; padding: 4px 8px;
  }
  .vol-apply {
    align-self: flex-end;
    background: linear-gradient(135deg, var(--water1), var(--accent));
    border: none; border-radius: 8px; padding: 5px 14px;
    font-family: 'DM Mono', monospace; font-size: 11px;
    color: #fff; cursor: pointer; transition: all 0.2s;
    box-shadow: 0 3px 12px rgba(14,165,233,0.3);
  }
  .vol-apply:hover { transform: translateY(-1px); box-shadow: 0 5px 18px rgba(14,165,233,0.45); }

  /* ‚îÄ‚îÄ DROPS ‚îÄ‚îÄ */
  .section-label {
    font-size: 10px; color: var(--muted);
    letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px;
  }
  .drops-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
  .drop { cursor: pointer; transition: transform 0.18s; }
  .drop:hover { transform: scale(1.18); }
  .drop svg { display: block; }
  .drop.active svg .drop-body {
    fill: var(--water1);
    filter: drop-shadow(0 0 4px rgba(14,165,233,0.7));
  }
  .drop:not(.active) svg .drop-body { fill: rgba(14,165,233,0.1); }
  @keyframes drop-pop {
    0%   { transform: scale(0.4) rotate(-15deg); opacity: 0; }
    65%  { transform: scale(1.35) rotate(4deg); }
    100% { transform: scale(1) rotate(0); opacity: 1; }
  }
  .drop.pop { animation: drop-pop 0.45s cubic-bezier(0.34,1.56,0.64,1) forwards; }

  .progress-track { height: 4px; background: rgba(14,165,233,0.1); border-radius: 4px; overflow: hidden; }
  .progress-fill {
    height: 100%; border-radius: 4px;
    background: linear-gradient(90deg, var(--water1), var(--foam));
    transition: width 0.6s ease; position: relative;
    box-shadow: 0 0 8px var(--glow);
  }
  .progress-fill::after {
    content: '';
    position: absolute; right: 0; top: 0; bottom: 0;
    width: 18px; background: rgba(255,255,255,0.4);
    border-radius: 4px; filter: blur(3px);
  }

  .divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(14,165,233,0.15), transparent); margin: 16px 0; }

  /* ‚îÄ‚îÄ BARS ‚îÄ‚îÄ */
  .graph-wrap { margin-bottom: 16px; }
  .bars { display: flex; align-items: flex-end; gap: 5px; height: 50px; }
  .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .bar { width: 100%; background: rgba(14,165,233,0.15); border-radius: 4px 4px 0 0; transition: height 0.5s cubic-bezier(0.34,1.56,0.64,1); }
  .bar.filled { background: linear-gradient(180deg, var(--water2) 0%, #0284c7 100%); box-shadow: 0 0 7px rgba(14,165,233,0.3); }
  .bar.today  { background: linear-gradient(180deg, var(--foam) 0%, var(--water1) 100%); box-shadow: 0 0 11px rgba(14,165,233,0.5); }
  .bar-day { font-size: 9px; color: var(--muted); }
  .bar-day.today-label { color: var(--water3); }

  .streak { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--muted); }
  .streak-fire { font-size: 15px; animation: flicker 1.5s ease-in-out infinite alternate; }
  @keyframes flicker { from { opacity:.7; transform:scale(.95); } to { opacity:1; transform:scale(1.05); } }
  .streak b { color: var(--water3); font-weight: 400; }

  .toast {
    position: absolute; top: 14px; left: 50%;
    transform: translateX(-50%) translateY(-60px);
    background: var(--accent); color: #fff;
    font-size: 11px; padding: 6px 16px; border-radius: 30px; white-space: nowrap;
    transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
    z-index: 10; pointer-events: none;
    box-shadow: 0 4px 20px rgba(6,182,212,0.4);
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .particle {
    position: absolute; pointer-events: none;
    border-radius: 50%; background: var(--water2);
    animation: particle-fly 0.8s ease-out forwards;
  }
  @keyframes particle-fly {
    0%   { transform: translate(0,0) scale(1); opacity: 0.8; }
    100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
  }
</style>
</head>
<body>
<div class="widget" id="widget">
  <div class="toast" id="toast"></div>

  <!-- HEADER -->
  <div class="header">
    <div class="title">Hidrata√ß√£o</div>
    <div class="date-badge" id="dateBadge">‚Äî</div>
  </div>

  <!-- VESSEL + STATS -->
  <div class="vessel-wrap">
    <div class="vessel-svg-wrap">

      <!--
        viewBox 0 0 72 160
        BOTTLE (full height):
          Cap:  x=24 y=2  w=24 h=9  rx=3
          Neck: x=27 y=11 w=18 h=15 rx=2
          Body: x=7  y=26 w=58 h=128 rx=10
          Shoulder: diagonal lines neck‚Üíbody

        CUP (bottom 80px: y=80..160):
          Trapezoid, open top

        clipPath for each = exact interior outline
        Water level = waterRect y & h, updated by JS
        Waves: outer <g> translateY to waterline (SVG attr updated by JS)
               inner <g> CSS animation translateX only ‚Üí no conflict
      -->
      <svg class="vessel-svg" id="vesselSvg" width="72" height="160"
           viewBox="0 0 72 160" onclick="addDrop(event)" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="waterGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%"   stop-color="#52c8f8"/>
            <stop offset="100%" stop-color="#0369a1"/>
          </linearGradient>
          <linearGradient id="glassGrad" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%"   stop-color="rgba(125,211,252,0.14)"/>
            <stop offset="100%" stop-color="rgba(125,211,252,0.02)"/>
          </linearGradient>

          <!--
            Bottle interior clipPath:
            Covers cap + neck + shoulder + body as one compound path.
            This is what the water+waves are clipped to.
          -->
          <clipPath id="bottleClip">
            <path d="
              M24 2 L48 2 Q52 2 52 6 L52 11
              L45 11 L45 26
              Q65 26 65 36 L65 144 Q65 154 55 154 L17 154 Q7 154 7 144
              L7 36 Q7 26 27 26
              L27 11 L20 11
              L20 6 Q20 2 24 2 Z
            "/>
          </clipPath>

          <!--
            Cup interior clipPath (trapezoid y=80..158)
          -->
          <clipPath id="cupClip">
            <path d="M11 80 L61 80 L67 150 Q67 158 59 158 L13 158 Q5 158 5 150 Z"/>
          </clipPath>
        </defs>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <g id="shapeBottle">
          <!-- Dark background -->
          <path d="
            M24 2 L48 2 Q52 2 52 6 L52 11
            L45 11 L45 26
            Q65 26 65 36 L65 144 Q65 154 55 154 L17 154 Q7 154 7 144
            L7 36 Q7 26 27 26
            L27 11 L20 11
            L20 6 Q20 2 24 2 Z"
            fill="rgba(3,17,31,0.72)"/>

          <!-- Water + waves, clipped to bottle interior -->
          <g clip-path="url(#bottleClip)">
            <!-- Solid water fill (rect from waterline down to bottom) -->
            <rect id="bottleWaterRect" x="-5" y="160" width="82" height="0"
                  fill="url(#waterGrad)"/>

            <!--
              Wave group: outer <g> Y-positioned to waterline via SVG transform (JS-updated)
              Inner <g> only handles X scroll via CSS animation
              Wave path period = 72px, drawn from x=-144 to x=+216 (4√ó wide)
            -->
            <g id="bottleWaveY" transform="translate(0,160)">
              <!-- Wave 1: R‚ÜíL -->
              <g class="wave-inner-1">
                <path d="
                  M-144 0
                  C-126 -9 -108 9 -90 0
                  C-72 -9  -54 9 -36 0
                  C-18 -9    0 9  18 0
                  C 36 -9   54 9  72 0
                  C 90 -9  108 9 126 0
                  C144 -9  162 9 180 0
                  C198 -9  216 9 252 0
                  L252 160 L-144 160 Z"
                  fill="rgba(255,255,255,0.11)"/>
              </g>
              <!-- Wave 2: L‚ÜíR (slower, opposite phase) -->
              <g class="wave-inner-2">
                <path d="
                  M-144 0
                  C-126 9 -108 -9 -90 0
                  C-72  9  -54 -9 -36 0
                  C-18  9    0 -9  18 0
                  C 36  9   54 -9  72 0
                  C 90  9  108 -9 126 0
                  C144  9  162 -9 180 0
                  C198  9  216 -9 252 0
                  L252 160 L-144 160 Z"
                  fill="rgba(255,255,255,0.07)"/>
              </g>
            </g>
          </g>

          <!-- Glass overlay (tint + outline) drawn ON TOP of water -->
          <path d="
            M24 2 L48 2 Q52 2 52 6 L52 11
            L45 11 L45 26
            Q65 26 65 36 L65 144 Q65 154 55 154 L17 154 Q7 154 7 144
            L7 36 Q7 26 27 26
            L27 11 L20 11
            L20 6 Q20 2 24 2 Z"
            fill="url(#glassGrad)"
            stroke="rgba(125,211,252,0.36)" stroke-width="1.6"/>

          <!-- Vertical shine highlight -->
          <path d="M13 40 Q14 95 13 142"
                stroke="rgba(255,255,255,0.07)" stroke-width="4"
                stroke-linecap="round" fill="none"/>
        </g>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CUP (hidden by default) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <g id="shapeCup" style="display:none">
          <!-- Dark background -->
          <path d="M11 80 L61 80 L67 150 Q67 158 59 158 L13 158 Q5 158 5 150 Z"
                fill="rgba(3,17,31,0.72)"/>

          <!-- Water + waves, clipped to cup interior -->
          <g clip-path="url(#cupClip)">
            <rect id="cupWaterRect" x="-5" y="160" width="82" height="0"
                  fill="url(#waterGrad)"/>
            <g id="cupWaveY" transform="translate(0,160)">
              <g class="wave-inner-1">
                <path d="
                  M-144 0 C-126 -9 -108 9 -90 0 C-72 -9 -54 9 -36 0
                  C-18 -9 0 9 18 0 C36 -9 54 9 72 0 C90 -9 108 9 126 0
                  C144 -9 162 9 180 0 C198 -9 216 9 252 0
                  L252 160 L-144 160 Z"
                  fill="rgba(255,255,255,0.11)"/>
              </g>
              <g class="wave-inner-2">
                <path d="
                  M-144 0 C-126 9 -108 -9 -90 0 C-72 9 -54 -9 -36 0
                  C-18 9 0 -9 18 0 C36 9 54 -9 72 0 C90 9 108 -9 126 0
                  C144 9 162 -9 180 0 C198 9 216 -9 252 0
                  L252 160 L-144 160 Z"
                  fill="rgba(255,255,255,0.07)"/>
              </g>
            </g>
          </g>

          <!-- Outline on top -->
          <path d="M11 80 L61 80 L67 150 Q67 158 59 158 L13 158 Q5 158 5 150 Z"
                fill="url(#glassGrad)"
                stroke="rgba(125,211,252,0.36)" stroke-width="1.6"/>
          <path d="M16 92 Q17 130 16 148"
                stroke="rgba(255,255,255,0.07)" stroke-width="3.5"
                stroke-linecap="round" fill="none"/>
        </g>
      </svg>

      <!-- Type toggle: single SVG icon for bottle, cup emoji -->
      <div class="type-toggle">
        <!-- Bottle: inline SVG mini icon (single bottle silhouette) -->
        <button class="type-btn active" id="btnBottle" onclick="setType('bottle')" title="Garrafa">
          <svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="4.5" y="0.5" width="5" height="3" rx="1"
                  stroke="rgba(125,211,252,0.8)" stroke-width="1"/>
            <path d="M4.5 3.5 Q2 4.5 2 7 L2 17 Q2 19.5 4.5 19.5 L9.5 19.5 Q12 19.5 12 17 L12 7 Q12 4.5 9.5 3.5"
                  stroke="rgba(125,211,252,0.8)" stroke-width="1" fill="none"/>
          </svg>
        </button>
        <!-- Cup: inline SVG mini icon -->
        <button class="type-btn" id="btnCup" onclick="setType('cup')" title="Copo">
          <svg width="16" height="14" viewBox="0 0 16 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 0.5 L15 0.5 L13 13 Q13 13.5 12.5 13.5 L3.5 13.5 Q3 13.5 3 13 Z"
                  stroke="rgba(125,211,252,0.8)" stroke-width="1" fill="none"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Stats -->
    <div class="vessel-stats">
      <div class="big-count">
        <span id="countDisplay">0</span>
        <span class="unit" id="unitDisplay">/ 4</span>
      </div>
      <div class="goal-line">
        <span id="goalDesc">garrafas de <b>500ml</b></span>
        <button class="vol-btn" onclick="toggleVolPanel()">‚öô Editar</button>
      </div>
      <div class="btns">
        <button class="btn btn-add" onclick="addDrop(event)">Ôºã</button>
        <button class="btn btn-remove" onclick="removeDrop()">Ôºç</button>
      </div>
    </div>
  </div>

  <!-- VOLUME CONFIG PANEL -->
  <div class="vol-panel" id="volPanel">
    <div class="vol-row">
      <label>Meta di√°ria total (ml)</label>
      <div class="num-wrap">
        <input class="vol-input" id="inputTotalMl" type="number" min="100" max="10000" step="100" value="2000">
        <div class="spin-btns">
          <button class="spin-btn" onclick="spinInput('inputTotalMl', 100)">‚Üë</button>
          <button class="spin-btn" onclick="spinInput('inputTotalMl', -100)">‚Üì</button>
        </div>
      </div>
    </div>
    <div class="vol-row">
      <label>Volume do recipiente (ml)</label>
      <div class="num-wrap">
        <input class="vol-input" id="inputContainerMl" type="number" min="50" max="5000" step="50" value="500">
        <div class="spin-btns">
          <button class="spin-btn" onclick="spinInput('inputContainerMl', 50)">‚Üë</button>
          <button class="spin-btn" onclick="spinInput('inputContainerMl', -50)">‚Üì</button>
        </div>
      </div>
    </div>
    <div class="vol-hint" id="volHint">‚Üí 4 garrafas necess√°rias</div>
    <button class="vol-apply" onclick="applyVolume()">Aplicar ‚úì</button>
  </div>

  <!-- DROPS -->
  <div>
    <div class="section-label">registro</div>
    <div class="drops-grid" id="dropsGrid"></div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
  </div>

  <div class="divider"></div>

  <!-- BAR CHART -->
  <div class="graph-wrap">
    <div class="section-label">√∫ltimos 7 dias</div>
    <div class="bars" id="barsGraph"></div>
  </div>

  <!-- STREAK -->
  <div class="streak">
    <span class="streak-fire">üî•</span>
    <span>Sequ√™ncia: <b id="streakCount">0</b> dias</span>
  </div>
</div>

<script>
  const DAYS = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
  const KEY  = 'hydro_v6';

  let config  = { totalMl: 2000, containerMl: 500, goal: 4, type: 'bottle' };
  let history = {};

  /* ‚îÄ‚îÄ PERSIST ‚îÄ‚îÄ */
  function load() {
    try {
      const raw = JSON.parse(localStorage.getItem(KEY)) || {};
      if (raw.config)  config  = Object.assign(config, raw.config);
      if (raw.history) history = raw.history;
    } catch {}
  }
  function save() { localStorage.setItem(KEY, JSON.stringify({ config, history })); }

  function todayKey() { return new Date().toISOString().slice(0,10); }
  function getCount() { return history[todayKey()] || 0; }
  function setCount(n) {
    history[todayKey()] = Math.max(0, Math.min(config.goal, n));
    save();
  }
  function calcGoal(total, cont) { return Math.max(1, Math.ceil(total / cont)); }

  /* ‚îÄ‚îÄ CUSTOM SPIN ‚îÄ‚îÄ */
  function spinInput(id, delta) {
    const el  = document.getElementById(id);
    const val = (parseInt(el.value) || 0) + delta;
    el.value  = Math.max(parseInt(el.min)||0, Math.min(parseInt(el.max)||99999, val));
    updateHint();
  }

  /* ‚îÄ‚îÄ FILL & WAVES ‚îÄ‚îÄ
     Bottle fill area: y=2 (cap top) to y=154 (body bottom) ‚Üí h=152
     Cup fill area:    y=80 (open top) to y=158 (bottom)   ‚Üí h=78

     waterRect: top = waterlineY, height = (bottom - waterlineY)
     waveY group: SVG transform="translate(0, waterlineY)" so waves sit at waterline
     CSS animation on inner groups only affects translateX ‚Üí no conflict
  */
  function updateVesselFill(count, animate) {
    const isCup   = config.type === 'cup';
    const top     = isCup ? 80  : 2;
    const bottom  = isCup ? 158 : 154;
    const fillH   = bottom - top;

    const pct      = Math.min(count / config.goal, 1);
    const waterH   = fillH * pct;
    const waterlineY = bottom - waterH;     // top of filled zone

    if (isCup) {
      const wr = document.getElementById('cupWaterRect');
      wr.setAttribute('y', waterlineY);
      wr.setAttribute('height', waterH);
      const wg = document.getElementById('cupWaveY');
      wg.setAttribute('transform', `translate(0,${waterlineY})`);
    } else {
      const wr = document.getElementById('bottleWaterRect');
      wr.setAttribute('y', waterlineY);
      wr.setAttribute('height', waterH);
      const wg = document.getElementById('bottleWaveY');
      wg.setAttribute('transform', `translate(0,${waterlineY})`);
    }
  }

  /* ‚îÄ‚îÄ TYPE ‚îÄ‚îÄ */
  function setType(t) {
    config.type = t;
    save();
    document.getElementById('shapeCup').style.display    = t === 'cup'    ? '' : 'none';
    document.getElementById('shapeBottle').style.display = t === 'bottle' ? '' : 'none';
    document.getElementById('btnCup').classList.toggle('active',    t === 'cup');
    document.getElementById('btnBottle').classList.toggle('active', t === 'bottle');
    updateGoalDesc();
    updateVesselFill(getCount(), false);
  }

  /* ‚îÄ‚îÄ VOL PANEL ‚îÄ‚îÄ */
  function toggleVolPanel() {
    const p = document.getElementById('volPanel');
    if (!p.classList.contains('open')) {
      document.getElementById('inputTotalMl').value     = config.totalMl;
      document.getElementById('inputContainerMl').value = config.containerMl;
      updateHint();
    }
    p.classList.toggle('open');
  }

  function updateHint() {
    const total = parseInt(document.getElementById('inputTotalMl').value)     || 2000;
    const cont  = parseInt(document.getElementById('inputContainerMl').value) || 500;
    const g     = calcGoal(total, cont);
    const noun  = config.type === 'bottle'
      ? (g === 1 ? 'garrafa' : 'garrafas')
      : (g === 1 ? 'copo' : 'copos');
    document.getElementById('volHint').textContent = `‚Üí ${g} ${noun} necess√°rios`;
  }

  function applyVolume() {
    config.totalMl     = Math.max(100, parseInt(document.getElementById('inputTotalMl').value)     || 2000);
    config.containerMl = Math.max(50,  parseInt(document.getElementById('inputContainerMl').value)  || 500);
    config.goal        = calcGoal(config.totalMl, config.containerMl);
    history[todayKey()] = Math.min(getCount(), config.goal);
    save();
    document.getElementById('volPanel').classList.remove('open');
    render();
  }

  function updateGoalDesc() {
    const noun = config.type === 'bottle' ? 'garrafas de' : 'copos de';
    document.getElementById('goalDesc').innerHTML = `${noun} <b>${config.containerMl}ml</b>`;
    document.getElementById('unitDisplay').textContent = `/ ${config.goal}`;
  }

  /* ‚îÄ‚îÄ STREAK ‚îÄ‚îÄ */
  function calcStreak() {
    let s = 0, d = new Date();
    d.setDate(d.getDate() - 1);
    while (s < 366) {
      const k = d.toISOString().slice(0,10);
      if ((history[k]||0) >= config.goal) { s++; d.setDate(d.getDate()-1); } else break;
    }
    return s;
  }

  /* ‚îÄ‚îÄ LAST 7 ‚îÄ‚îÄ */
  function getLast7() {
    const today = new Date();
    return Array.from({length:7}, (_,i) => {
      const dt = new Date(today);
      dt.setDate(dt.getDate() - (6-i));
      const k = dt.toISOString().slice(0,10);
      return { day: DAYS[dt.getDay()], val: history[k]||0, isToday: i===6 };
    });
  }

  /* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
  function renderDrops(count) {
    const grid = document.getElementById('dropsGrid');
    grid.innerHTML = '';
    const size = config.goal > 16 ? 20 : config.goal > 12 ? 22 : 26;
    for (let i = 0; i < config.goal; i++) {
      const div = document.createElement('div');
      div.className = 'drop' + (i < count ? ' active' : '');
      div.style.width = div.style.height = size + 'px';
      const lbl = config.type === 'bottle' ? 'Garrafa' : 'Copo';
      div.title = `${lbl} ${i+1}${i < count ? ' ‚úì' : ''}`;
      div.innerHTML = `<svg width="${size}" height="${size}" viewBox="0 0 24 30" fill="none">
        <path class="drop-body"
          d="M12 2C12 2 3 13 3 19C3 24.5 7 28 12 28C17 28 21 24.5 21 19C21 13 12 2 12 2Z"
          stroke="rgba(125,211,252,0.3)" stroke-width="0.5"/>
        <path d="M8 21C8 21 9 24 12 24"
              stroke="rgba(255,255,255,0.25)" stroke-width="1" stroke-linecap="round"/>
      </svg>`;
      const idx = i;
      div.onclick = (e) => {
        e.stopPropagation();
        if (idx < count) { setCount(idx+1); render(false); }
        else             { setCount(idx+1); render(true);  }
      };
      grid.appendChild(div);
    }
  }

  function renderBars() {
    const data = getLast7();
    const c = document.getElementById('barsGraph');
    c.innerHTML = '';
    const maxVal = Math.max(config.goal, ...data.map(d=>d.val));
    data.forEach(item => {
      const col = document.createElement('div');
      col.className = 'bar-col';
      const bar = document.createElement('div');
      bar.className = 'bar'
        + (item.val >= config.goal && !item.isToday ? ' filled' : '')
        + (item.isToday ? ' today' : '');
      bar.style.height = Math.max(4, (item.val/maxVal)*50) + 'px';
      bar.title = `${item.val}/${config.goal}`;
      const lbl = document.createElement('div');
      lbl.className = 'bar-day' + (item.isToday ? ' today-label' : '');
      lbl.textContent = item.isToday ? 'Hoje' : item.day;
      col.appendChild(bar); col.appendChild(lbl);
      c.appendChild(col);
    });
  }

  function render(animate = false) {
    const count = getCount();
    document.getElementById('countDisplay').textContent = count;
    updateGoalDesc();
    setType(config.type);
    updateVesselFill(count, animate);
    renderDrops(count);
    renderBars();
    document.getElementById('progressFill').style.width = (count/config.goal*100) + '%';
    document.getElementById('streakCount').textContent  = calcStreak();

    if (animate) {
      const drops = document.querySelectorAll('.drop.active');
      const last  = drops[drops.length-1];
      if (last) {
        last.classList.add('pop');
        last.addEventListener('animationend', () => last.classList.remove('pop'), {once:true});
      }
    }
  }

  /* ‚îÄ‚îÄ PARTICLES ‚îÄ‚îÄ */
  function spawnParticles(e) {
    const widget = document.getElementById('widget');
    const rect   = widget.getBoundingClientRect();
    for (let i = 0; i < 9; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      const size  = 3 + Math.random()*5;
      const angle = Math.random()*Math.PI*2;
      const dist  = 25 + Math.random()*55;
      p.style.cssText = `
        width:${size}px;height:${size}px;
        left:${(e.clientX||150)-rect.left}px;
        top:${(e.clientY||180)-rect.top}px;
        --tx:${Math.cos(angle)*dist}px;
        --ty:${Math.sin(angle)*dist}px;
      `;
      widget.appendChild(p);
      setTimeout(() => p.remove(), 820);
    }
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  function addDrop(e) {
    const before = getCount();
    if (before >= config.goal) { showToast('üéâ Meta j√° atingida!'); return; }
    setCount(before + 1);
    render(true);
    if (e) spawnParticles(e);
    if (before + 1 === config.goal)
      setTimeout(() => showToast('üíß Meta atingida! Parab√©ns!'), 350);
  }

  function removeDrop() { setCount(getCount()-1); render(false); }

  function updateDate() {
    const now = new Date();
    document.getElementById('dateBadge').innerHTML =
      now.toLocaleDateString('pt-BR',{weekday:'long'}).toUpperCase() + '<br>' +
      now.toLocaleDateString('pt-BR',{day:'numeric',month:'short'}).toUpperCase();
  }

  /* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
  load();
  updateDate();
  render();

  document.getElementById('inputTotalMl').addEventListener('input', updateHint);
  document.getElementById('inputContainerMl').addEventListener('input', updateHint);
</script>
</body>
</html>
